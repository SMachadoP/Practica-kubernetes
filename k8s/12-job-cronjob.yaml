# ====================================================
# JOB - Tarea que se ejecuta hasta completarse
# ====================================================
# Un Job crea uno o más pods y asegura que un número
# específico de ellos termina exitosamente.
#
# Casos de uso:
# - Procesamiento batch
# - Migraciones de base de datos
# - Tareas de backup
# - Procesamiento de datos one-time
#
# Diferencia con Deployment:
# - Deployment: mantiene pods corriendo indefinidamente
# - Job: ejecuta hasta completar y termina
# ====================================================

apiVersion: batch/v1
kind: Job
metadata:
  name: demo-job
  namespace: prackube
  labels:
    app: demo-job
spec:
  # Número de veces que el Job debe completarse exitosamente
  completions: 3
  
  # Cuántos pods pueden correr en paralelo
  parallelism: 2
  
  # Cuántas veces reintentar antes de marcar como fallido
  backoffLimit: 4
  
  # Tiempo máximo de ejecución (segundos)
  activeDeadlineSeconds: 600    # 10 minutos
  
  # TTL para limpiar Jobs completados automáticamente
  ttlSecondsAfterFinished: 300  # Eliminar 5 min después de completar
  
  template:
    spec:
      containers:
        - name: job-container
          image: busybox
          command: ["sh", "-c"]
          args:
            - |
              echo "Iniciando Job en pod: $(hostname)"
              echo "Procesando datos..."
              sleep 10
              echo "Job completado exitosamente!"
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
      
      # Política de reinicio para Jobs DEBE ser Never o OnFailure
      restartPolicy: Never

---
# ====================================================
# CRONJOB - Job programado (como cron de Linux)
# ====================================================
# CronJob crea Jobs en un horario definido.
#
# Formato cron: "minuto hora día-mes mes día-semana"
# Ejemplos:
# - "*/5 * * * *"  = cada 5 minutos
# - "0 * * * *"    = cada hora
# - "0 0 * * *"    = cada día a medianoche
# - "0 0 * * 0"    = cada domingo a medianoche
# - "0 0 1 * *"    = primer día de cada mes
# ====================================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: demo-cronjob
  namespace: prackube
  labels:
    app: demo-cronjob
spec:
  # Horario en formato cron (cada 5 minutos)
  schedule: "*/5 * * * *"
  
  # Zona horaria (requiere Kubernetes 1.27+)
  # timeZone: "America/Mexico_City"
  
  # Política de concurrencia
  # Allow: permite múltiples Jobs simultáneos
  # Forbid: no crear nuevo Job si el anterior está corriendo
  # Replace: reemplazar Job anterior si está corriendo
  concurrencyPolicy: Forbid
  
  # Cuántos Jobs completados mantener en historial
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  
  # Deadline para iniciar el Job (si se pasó la hora programada)
  startingDeadlineSeconds: 60
  
  # Suspender el CronJob (útil para mantenimiento)
  suspend: false
  
  # Template del Job (igual que un Job normal)
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: cronjob-container
              image: busybox
              command: ["sh", "-c"]
              args:
                - |
                  echo "=== CronJob ejecutado: $(date) ==="
                  echo "Pod: $(hostname)"
                  echo "Realizando tarea programada..."
                  sleep 5
                  echo "Tarea completada"
              resources:
                requests:
                  memory: "32Mi"
                  cpu: "50m"
                limits:
                  memory: "64Mi"
                  cpu: "100m"
          restartPolicy: OnFailure
